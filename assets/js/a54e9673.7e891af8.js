"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[963],{78:(e,n,r)=>{r.d(n,{A:()=>i});r(8225);var t=r(3372);const a={tabItem:"tabItem_k9Yy"};var s=r(7557);function i(e){let{children:n,hidden:r,className:i}=e;return(0,s.jsx)("div",{role:"tabpanel",className:(0,t.A)(a.tabItem,i),hidden:r,children:n})}},1414:(e,n,r)=>{r.d(n,{A:()=>q});var t=r(8225),a=r(3372),s=r(2646),i=r(1654),o=r(8322),l=r(9467),c=r(1544),d=r(5126);function u(e){return t.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,t.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:n,children:r}=e;return(0,t.useMemo)((()=>{const e=n??function(e){return u(e).map((e=>{let{props:{value:n,label:r,attributes:t,default:a}}=e;return{value:n,label:r,attributes:t,default:a}}))}(r);return function(e){const n=(0,c.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,r])}function p(e){let{value:n,tabValues:r}=e;return r.some((e=>e.value===n))}function m(e){let{queryString:n=!1,groupId:r}=e;const a=(0,i.W6)(),s=function(e){let{queryString:n=!1,groupId:r}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!r)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return r??null}({queryString:n,groupId:r});return[(0,l.aZ)(s),(0,t.useCallback)((e=>{if(!s)return;const n=new URLSearchParams(a.location.search);n.set(s,e),a.replace({...a.location,search:n.toString()})}),[s,a])]}function f(e){const{defaultValue:n,queryString:r=!1,groupId:a}=e,s=h(e),[i,l]=(0,t.useState)((()=>function(e){let{defaultValue:n,tabValues:r}=e;if(0===r.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!p({value:n,tabValues:r}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${r.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const t=r.find((e=>e.default))??r[0];if(!t)throw new Error("Unexpected error: 0 tabValues");return t.value}({defaultValue:n,tabValues:s}))),[c,u]=m({queryString:r,groupId:a}),[f,b]=function(e){let{groupId:n}=e;const r=function(e){return e?`docusaurus.tab.${e}`:null}(n),[a,s]=(0,d.Dv)(r);return[a,(0,t.useCallback)((e=>{r&&s.set(e)}),[r,s])]}({groupId:a}),g=(()=>{const e=c??f;return p({value:e,tabValues:s})?e:null})();(0,o.A)((()=>{g&&l(g)}),[g]);return{selectedValue:i,selectValue:(0,t.useCallback)((e=>{if(!p({value:e,tabValues:s}))throw new Error(`Can't select invalid tab value=${e}`);l(e),u(e),b(e)}),[u,b,s]),tabValues:s}}var b=r(8442);const g={tabList:"tabList_CY6c",tabItem:"tabItem_IDbK"};var y=r(7557);function x(e){let{className:n,block:r,selectedValue:t,selectValue:i,tabValues:o}=e;const l=[],{blockElementScrollPositionUntilNextRender:c}=(0,s.a_)(),d=e=>{const n=e.currentTarget,r=l.indexOf(n),a=o[r].value;a!==t&&(c(n),i(a))},u=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const r=l.indexOf(e.currentTarget)+1;n=l[r]??l[0];break}case"ArrowLeft":{const r=l.indexOf(e.currentTarget)-1;n=l[r]??l[l.length-1];break}}n?.focus()};return(0,y.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.A)("tabs",{"tabs--block":r},n),children:o.map((e=>{let{value:n,label:r,attributes:s}=e;return(0,y.jsx)("li",{role:"tab",tabIndex:t===n?0:-1,"aria-selected":t===n,ref:e=>{l.push(e)},onKeyDown:u,onClick:d,...s,className:(0,a.A)("tabs__item",g.tabItem,s?.className,{"tabs__item--active":t===n}),children:r??n},n)}))})}function j(e){let{lazy:n,children:r,selectedValue:s}=e;const i=(Array.isArray(r)?r:[r]).filter(Boolean);if(n){const e=i.find((e=>e.props.value===s));return e?(0,t.cloneElement)(e,{className:(0,a.A)("margin-top--md",e.props.className)}):null}return(0,y.jsx)("div",{className:"margin-top--md",children:i.map(((e,n)=>(0,t.cloneElement)(e,{key:n,hidden:e.props.value!==s})))})}function v(e){const n=f(e);return(0,y.jsxs)("div",{className:(0,a.A)("tabs-container",g.tabList),children:[(0,y.jsx)(x,{...n,...e}),(0,y.jsx)(j,{...n,...e})]})}function q(e){const n=(0,b.A)();return(0,y.jsx)(v,{...e,children:u(e.children)},String(n))}},4262:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>p,frontMatter:()=>l,metadata:()=>t,toc:()=>u});const t=JSON.parse('{"id":"reference/databases","title":"Databases","description":"Working with databases in FTL","source":"@site/docs/reference/databases.md","sourceDirName":"reference","slug":"/reference/databases","permalink":"/ftl/docs/reference/databases","draft":false,"unlisted":false,"editUrl":"https://github.com/block/ftl/tree/main/docs/docs/reference/databases.md","tags":[],"version":"current","sidebarPosition":17,"frontMatter":{"sidebar_position":17,"title":"Databases","description":"Working with databases in FTL"},"sidebar":"tutorialSidebar","previous":{"title":"External Types","permalink":"/ftl/docs/reference/externaltypes"}}');var a=r(7557),s=r(6039),i=r(1414),o=r(78);const l={sidebar_position:17,title:"Databases",description:"Working with databases in FTL"},c="Databases",d={},u=[{value:"SQL File Structure",id:"sql-file-structure",level:2},{value:"Schema Directory",id:"schema-directory",level:3},{value:"Queries Directory",id:"queries-directory",level:3},{value:"Provisioning",id:"provisioning",level:2},{value:"Migrations",id:"migrations",level:2},{value:"Connecting with your DB",id:"connecting-with-your-db",level:2},{value:"Using the Database Handle",id:"using-the-database-handle",level:3},{value:"Using Generated Query Clients",id:"using-generated-query-clients",level:3}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"databases",children:"Databases"})}),"\n",(0,a.jsx)(n.p,{children:"FTL has support for Postgresql and MySQL databases, including support for automatic provisioning and migrations."}),"\n",(0,a.jsx)(n.p,{children:"The process for declaring a database differs by language."}),"\n","\n",(0,a.jsxs)(i.A,{groupId:"languages",children:[(0,a.jsx)(o.A,{value:"go",label:"Go",default:!0,children:(0,a.jsxs)(n.p,{children:["Your database is automatically declared by following a specific directory structure for your SQL files. No additional configuration is needed - just create the directory structure and FTL will handle the rest. See the ",(0,a.jsx)(n.a,{href:"#sql-file-structure",children:"SQL File Structure"})," section below for more details."]})}),(0,a.jsxs)(o.A,{value:"kotlin",label:"Kotlin",children:[(0,a.jsxs)(n.p,{children:["To declare a datasource in Kotlin you must use the ",(0,a.jsx)(n.code,{children:"@SQLDatasource"})," annotation. This annotations is used to define\nthe database name and type."]}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-kotlin",children:'@SQLDatasource(name = "testdb", type = SQLDatabaseType.POSTGRESQL)\n'})}),(0,a.jsxs)(n.p,{children:["You must also include the appropriate depdencies in your ",(0,a.jsx)(n.code,{children:"pom.xml"})," for the database you are using:"]}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>io.quarkus</groupId>\n    <artifactId>quarkus-jdbc-postgresql</artifactId>\n</dependency>\n<dependency>\n    <groupId>io.quarkus</groupId>\n    <artifactId>quarkus-jdbc-mysql</artifactId>\n</dependency>\n"})}),(0,a.jsxs)(n.p,{children:["You can also use ",(0,a.jsx)(n.a,{href:"https://quarkus.io/guides/hibernate-orm",children:"Hibernate directly"})," or using ",(0,a.jsx)(n.a,{href:"https://quarkus.io/guides/hibernate-orm-panache",children:"Panache"}),"."]}),(0,a.jsx)(n.p,{children:"This will require adding one of the following dependencies:"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>io.quarkus</groupId>\n    <artifactId>quarkus-hibernate-orm</artifactId>\n</dependency>\n<dependency>\n    <groupId>io.quarkus</groupId>\n    <artifactId>quarkus-hibernate-orm-panache</artifactId>\n</dependency>\n"})}),(0,a.jsx)(n.p,{children:"Note that this will likely change significantly in future once FTL has SQL Verbs."})]}),(0,a.jsxs)(o.A,{value:"java",label:"Java",children:[(0,a.jsxs)(n.p,{children:["To declare a datasource in Java you must use the ",(0,a.jsx)(n.code,{children:"@SQLDatasource"})," annotation. This annotations is used to define\nthe database name and type."]}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'@SQLDatasource(name = "testdb", type = SQLDatabaseType.POSTGRESQL)\n'})}),(0,a.jsxs)(n.p,{children:["You must also include the appropriate depdencies in your ",(0,a.jsx)(n.code,{children:"pom.xml"})," for the database you are using:"]}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>io.quarkus</groupId>\n    <artifactId>quarkus-jdbc-postgresql</artifactId>\n</dependency>\n<dependency>\n    <groupId>io.quarkus</groupId>\n    <artifactId>quarkus-jdbc-mysql</artifactId>\n</dependency>\n"})}),(0,a.jsxs)(n.p,{children:["You can also use ",(0,a.jsx)(n.a,{href:"https://quarkus.io/guides/hibernate-orm",children:"Hibernate directly"})," or using ",(0,a.jsx)(n.a,{href:"https://quarkus.io/guides/hibernate-orm-panache",children:"Panache"}),"."]}),(0,a.jsx)(n.p,{children:"This will require adding one of the following dependencies:"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>io.quarkus</groupId>\n    <artifactId>quarkus-hibernate-orm</artifactId>\n</dependency>\n<dependency>\n    <groupId>io.quarkus</groupId>\n    <artifactId>quarkus-hibernate-orm-panache</artifactId>\n</dependency>\n"})}),(0,a.jsx)(n.p,{children:"Note that this will likely change significantly in future once JVM supports SQL verbs."})]})]}),"\n",(0,a.jsx)(n.h2,{id:"sql-file-structure",children:"SQL File Structure"}),"\n",(0,a.jsxs)(n.p,{children:["In order to be discoverable by FTL, the SQL files in your project must follow a specific directory structure. FTL supports two database engines, and the corresponding directory must be named exactly ",(0,a.jsx)(n.code,{children:"mysql"})," or ",(0,a.jsx)(n.code,{children:"postgres"}),":"]}),"\n",(0,a.jsxs)(i.A,{groupId:"languages",children:[(0,a.jsxs)(o.A,{value:"go",label:"Go",default:!0,children:[(0,a.jsx)(n.p,{children:"For Go projects, SQL files must be located in:"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'db/\n  \u251c\u2500\u2500 mysql/           # must be exactly "mysql" or "postgres"\n  \u2502   \u2514\u2500\u2500 mydb/        # database name\n  \u2502       \u251c\u2500\u2500 schema/  # contains migration files\n  \u2502       \u2514\u2500\u2500 queries/ # contains query files\n'})}),(0,a.jsxs)(n.p,{children:["The presence of a ",(0,a.jsx)(n.code,{children:"schema"})," directory under your database name automatically declares the database in FTL."]})]}),(0,a.jsxs)(o.A,{value:"kotlin",label:"Kotlin",children:[(0,a.jsx)(n.p,{children:"For Kotlin projects, SQL files must be located in:"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'src/main/resources/\n  \u2514\u2500\u2500 db/\n      \u251c\u2500\u2500 mysql/           # must be exactly "mysql" or "postgres"\n      \u2502   \u2514\u2500\u2500 mydb/        # database name\n      \u2502       \u251c\u2500\u2500 schema/  # contains migration files\n      \u2502       \u2514\u2500\u2500 queries/ # contains query files\n'})})]}),(0,a.jsxs)(o.A,{value:"java",label:"Java",children:[(0,a.jsx)(n.p,{children:"For Java projects, SQL files must be located in:"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'src/main/resources/\n  \u2514\u2500\u2500 db/\n      \u251c\u2500\u2500 mysql/           # must be exactly "mysql" or "postgres"\n      \u2502   \u2514\u2500\u2500 mydb/        # database name\n      \u2502       \u251c\u2500\u2500 schema/  # contains migration files\n      \u2502       \u2514\u2500\u2500 queries/ # contains query files\n'})})]})]}),"\n",(0,a.jsx)(n.h3,{id:"schema-directory",children:"Schema Directory"}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"schema"})," directory contains all your database migration ",(0,a.jsx)(n.code,{children:".sql"})," files. These files are used to create and modify your database schema."]}),"\n",(0,a.jsx)(n.h3,{id:"queries-directory",children:"Queries Directory"}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"queries"})," directory contains ",(0,a.jsx)(n.code,{children:".sql"})," files with any SQL queries you would like to make available to your application. These queries must be annotated with ",(0,a.jsx)(n.a,{href:"https://docs.sqlc.dev/",children:"SQLC annotation syntax"}),". FTL will automatically lift these queries into the module schema, making each query available as its own FTL verb."]}),"\n",(0,a.jsxs)(n.p,{children:["Find more information in the ",(0,a.jsx)(n.a,{href:"#using-generated-query-clients",children:"Using Generated Query Clients"})," section below."]}),"\n",(0,a.jsx)(n.h2,{id:"provisioning",children:"Provisioning"}),"\n",(0,a.jsxs)(n.p,{children:["FTL includes support for automatically provisioning databases. The actual backing implementation is\nextensible, and presently we include support for both local development provisioning using docker,\nand cloud formations based provisioning for AWS deployments. When using ",(0,a.jsx)(n.code,{children:"ftl dev"})," a docker container\nwill automatically be spun up for each datasource that has been defined, and FTL will automatically\nhandle configuration. The same applies when deploying to an AWS cluster with cloud formations\nprovisioning setup."]}),"\n",(0,a.jsx)(n.h2,{id:"migrations",children:"Migrations"}),"\n",(0,a.jsxs)(n.p,{children:["FTL includes support for automatically running migrations on databases. This is provided by ",(0,a.jsx)(n.a,{href:"https://github.com/amacneil/dbmate",children:"dbmate"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["To create migrations you can use the ",(0,a.jsx)(n.code,{children:"ftl new-sql-migration"})," command. This will create new migration files, and initialize the required\ndirectory structure if it does not exist. The format of the command is ",(0,a.jsx)(n.code,{children:"ftl new-sql-migration <module>.<datasource> <migration-name>"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"The module name can be omitted if the current working directory only contains a single module."}),"\n",(0,a.jsxs)(n.p,{children:["E.g. to create a new migration called ",(0,a.jsx)(n.code,{children:"init"})," for the ",(0,a.jsx)(n.code,{children:"testdb"})," datasource in the ",(0,a.jsx)(n.code,{children:"mysql"})," module you would run ",(0,a.jsx)(n.code,{children:"ftl new-sql-migration mysql.testdb init"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"When the modules are provisioned FTL will automatically run these migrations for you."}),"\n",(0,a.jsx)(n.h2,{id:"connecting-with-your-db",children:"Connecting with your DB"}),"\n",(0,a.jsx)(n.p,{children:"There are two ways to interact with your database in FTL: using the database handle for raw queries, or using generated query clients."}),"\n",(0,a.jsx)(n.h3,{id:"using-the-database-handle",children:"Using the Database Handle"}),"\n",(0,a.jsx)(i.A,{groupId:"languages",children:(0,a.jsxs)(o.A,{value:"go",label:"Go",default:!0,children:[(0,a.jsx)(n.p,{children:"Once you have a database declared through the directory structure, FTL automatically generates a database handle that provides direct access to the underlying database connection. You can use this to execute raw SQL queries:"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:'//ftl:verb export\nfunc Query(ctx context.Context, db DatabaseHandle) ([]string, error) {\n\trows, err := db.QueryContext(ctx, "SELECT data FROM requests")\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tdefer rows.Close()\n\tvar items []string\n\tfor rows.Next() {\n\t\tvar i string\n\t\tif err := rows.Scan(&i); err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t\titems = append(items, i)\n\t}\n\tif err := rows.Close(); err != nil {\n\t\treturn nil, err\n\t}\n\tif err := rows.Err(); err != nil {\n\t\treturn nil, err\n\t}\n\treturn items, nil\n}\n'})})]})}),"\n",(0,a.jsx)(n.h3,{id:"using-generated-query-clients",children:"Using Generated Query Clients"}),"\n",(0,a.jsxs)(n.p,{children:["For better type safety and maintainability, FTL can automatically generate type-safe query clients from SQL files in your ",(0,a.jsx)(n.code,{children:"queries"})," directory. Your SQL files must be annotated with ",(0,a.jsx)(n.a,{href:"https://docs.sqlc.dev/",children:"SQLC annotation syntax"})," to specify the type of query and its parameters. For example:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"-- name: GetUser :one\nSELECT id, name, email\nFROM users\nWHERE id = $1;\n\n-- name: ListUsers :many\nSELECT id, name, email\nFROM users\nORDER BY name;\n\n-- name: CreateUser :exec\nINSERT INTO users (name, email)\nVALUES ($1, $2);\n"})}),"\n",(0,a.jsx)(n.p,{children:"These queries will be automatically converted into FTL verbs with corresponding generated clients that you can inject into your verbs just like any other verb client. For example:"}),"\n",(0,a.jsx)(i.A,{groupId:"languages",children:(0,a.jsx)(o.A,{value:"go",label:"Go",default:!0,children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"//ftl:verb export\nfunc Query(ctx context.Context, query GetRequestDataClient) ([]string, error) {\n\trows, err := query(ctx)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tvar items []string\n\tfor _, row := range rows {\n\t\tif d, ok := row.Data.Get(); ok {\n\t\t\titems = append(items, d)\n\t\t}\n\t}\n\treturn items, nil\n}\n"})})})})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},6039:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>o});var t=r(8225);const a={},s=t.createContext(a);function i(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);