"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[963],{1407:(e,n,a)=>{a.d(n,{A:()=>i});a(8225);var r=a(3372);const t={tabItem:"tabItem_LXtO"};var s=a(7557);function i(e){let{children:n,hidden:a,className:i}=e;return(0,s.jsx)("div",{role:"tabpanel",className:(0,r.A)(t.tabItem,i),hidden:a,children:n})}},7389:(e,n,a)=>{a.d(n,{R:()=>i,x:()=>l});var r=a(8225);const t={},s=r.createContext(t);function i(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(s.Provider,{value:n},e.children)}},8298:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>m,frontMatter:()=>c,metadata:()=>r,toc:()=>u});const r=JSON.parse('{"id":"reference/databases","title":"Databases","description":"Working with databases in FTL","source":"@site/docs/reference/databases.md","sourceDirName":"reference","slug":"/reference/databases","permalink":"/ftl/docs/reference/databases","draft":false,"unlisted":false,"editUrl":"https://github.com/block/ftl/tree/main/docs/docs/reference/databases.md","tags":[],"version":"current","sidebarPosition":17,"frontMatter":{"sidebar_position":17,"title":"Databases","description":"Working with databases in FTL"},"sidebar":"tutorialSidebar","previous":{"title":"External Types","permalink":"/ftl/docs/reference/externaltypes"},"next":{"title":"Workload Identity","permalink":"/ftl/docs/reference/workloadidentity"}}');var t=a(7557),s=a(7389),i=a(9077),l=a(1407);const c={sidebar_position:17,title:"Databases",description:"Working with databases in FTL"},o="Databases",d={},u=[{value:"Creating a New Database",id:"creating-a-new-database",level:2},{value:"SQL File Structure",id:"sql-file-structure",level:2},{value:"Schema Directory",id:"schema-directory",level:3},{value:"Queries Directory",id:"queries-directory",level:3},{value:"Provisioning",id:"provisioning",level:2},{value:"Migrations",id:"migrations",level:2},{value:"Connecting with your DB",id:"connecting-with-your-db",level:2},{value:"Using the Generated Database Handle",id:"using-the-generated-database-handle",level:3},{value:"Using Generated Query Clients",id:"using-generated-query-clients",level:3},{value:"Transactions",id:"transactions",level:2},{value:"Transaction Rules and Limitations",id:"transaction-rules-and-limitations",level:3}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"databases",children:"Databases"})}),"\n",(0,t.jsx)(n.p,{children:"FTL has support for Postgresql and MySQL databases, including support for automatic provisioning and migrations."}),"\n","\n",(0,t.jsxs)(i.A,{groupId:"languages",children:[(0,t.jsx)(l.A,{value:"go",label:"Go",default:!0,children:(0,t.jsxs)(n.p,{children:["Your database is automatically declared by following a specific directory structure for your SQL files. No additional configuration is needed - just create the directory structure and FTL will handle the rest. See the ",(0,t.jsx)(n.a,{href:"#creating-a-new-database",children:"Creating a New Database"})," section for CLI shortcuts."]})}),(0,t.jsx)(l.A,{value:"kotlin",label:"Kotlin",children:(0,t.jsxs)(n.p,{children:["Your database is automatically declared by following a specific directory structure for your SQL files. No additional configuration is needed - just create the directory structure and FTL will handle the rest. See the ",(0,t.jsx)(n.a,{href:"#creating-a-new-database",children:"Creating a New Database"})," section for CLI shortcuts."]})}),(0,t.jsx)(l.A,{value:"java",label:"Java",children:(0,t.jsxs)(n.p,{children:["Your database is automatically declared by following a specific directory structure for your SQL files. No additional configuration is needed - just create the directory structure and FTL will handle the rest. See the ",(0,t.jsx)(n.a,{href:"#creating-a-new-database",children:"Creating a New Database"})," section for CLI shortcuts."]})}),(0,t.jsxs)(l.A,{value:"schema",label:"Schema",children:[(0,t.jsxs)(n.p,{children:["In the FTL schema, databases are represented using the ",(0,t.jsx)(n.code,{children:"database"})," keyword with the engine type and name:"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-schema",children:'module example {\n  // Database declaration\n  database postgres testdb  \n    +migration sha256:59b989063b6de57a1b6867e8ad7915109c9b8632616118c6ef23e4439cf17f8e\n  \n  // Data structures for database operations\n  data CreateUserParams {\n    name String\n    email String\n  }\n  \n  data UserResult {\n    id Int +sql column "users"."id"\n    name String +sql column "users"."name"\n    email String +sql column "users"."email"\n  }\n  \n  // Query that returns a single row\n  verb getUser(Int) example.UserResult\n    +database calls example.testdb\n    +sql query one "SELECT id, name, email FROM users WHERE id = ?"\n  \n  // Query that returns multiple rows\n  verb listUsers(Unit) [example.UserResult]\n    +database calls example.testdb\n    +sql query many "SELECT id, name, email FROM users ORDER BY name"\n  \n  // Query that performs an action but doesn\'t return data\n  verb createUser(example.CreateUserParams) Unit\n    +database calls example.testdb\n    +sql query exec "INSERT INTO users (name, email) VALUES (?, ?)"\n  \n  // Custom verb that uses a database query\n  export verb getUserEmail(Int) String\n}\n'})}),(0,t.jsx)(n.p,{children:"The schema representation includes:"}),(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["A ",(0,t.jsx)(n.code,{children:"database"})," declaration with the engine type (",(0,t.jsx)(n.code,{children:"postgres"})," or ",(0,t.jsx)(n.code,{children:"mysql"}),") and database name"]}),"\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.code,{children:"+migration"})," annotation with a SHA256 hash of the migration files"]}),"\n",(0,t.jsxs)(n.li,{children:["Data structures with ",(0,t.jsx)(n.code,{children:"+sql column"})," annotations mapping to database columns"]}),"\n",(0,t.jsxs)(n.li,{children:["Verb declarations with ",(0,t.jsx)(n.code,{children:"+database calls"})," and ",(0,t.jsx)(n.code,{children:"+sql query"})," annotations specifying the query type and SQL statement"]}),"\n"]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"creating-a-new-database",children:"Creating a New Database"}),"\n",(0,t.jsxs)(n.p,{children:["To create a new database with the required directory structure, you can use the ",(0,t.jsx)(n.code,{children:"ftl postgres new"})," or ",(0,t.jsx)(n.code,{children:"ftl mysql new"})," command. The format of the command is:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"ftl <engine> new <module>.<datasource>\n"})}),"\n",(0,t.jsx)(n.p,{children:"Where:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"<engine>"})," is either ",(0,t.jsx)(n.code,{children:"mysql"})," or ",(0,t.jsx)(n.code,{children:"postgres"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"<module>.<datasource>"})," is the qualified name of the datasource (module name can be omitted if in a single module directory)"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"For example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'ftl mysql new mymodule.mydb    # Create a MySQL database named "mydb" in module "mymodule"\nftl postgres new mydb          # Create a PostgreSQL database named "mydb" in the current module\n'})}),"\n",(0,t.jsx)(n.p,{children:"This command will:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Create the appropriate directory structure"}),"\n",(0,t.jsxs)(n.li,{children:["Create an initial migration file in the ",(0,t.jsx)(n.code,{children:"schema"})," directory"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"sql-file-structure",children:"SQL File Structure"}),"\n",(0,t.jsxs)(n.p,{children:["In order to be discoverable by FTL, the SQL files in your project must follow a specific directory structure. FTL supports two database engines, declared via the directory hierarchy as either ",(0,t.jsx)(n.code,{children:"mysql"})," or ",(0,t.jsx)(n.code,{children:"postgres"}),":"]}),"\n",(0,t.jsxs)(i.A,{groupId:"languages",children:[(0,t.jsxs)(l.A,{value:"go",label:"Go",default:!0,children:[(0,t.jsx)(n.p,{children:"For Go projects, SQL files must be located in:"}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'db/\n  \u251c\u2500\u2500 mysql/           # must be exactly "mysql" or "postgres"\n  \u2502   \u2514\u2500\u2500 mydb/        # database name\n  \u2502       \u251c\u2500\u2500 schema/  # contains migration files\n  \u2502       \u2514\u2500\u2500 queries/ # contains query files\n'})}),(0,t.jsxs)(n.p,{children:["The presence of a ",(0,t.jsx)(n.code,{children:"schema"})," directory under your database name automatically declares the database in FTL."]})]}),(0,t.jsxs)(l.A,{value:"kotlin",label:"Kotlin",children:[(0,t.jsx)(n.p,{children:"For Kotlin projects, SQL files must be located in:"}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'src/main/resources/\n  \u2514\u2500\u2500 db/\n      \u251c\u2500\u2500 mysql/           # must be exactly "mysql" or "postgres"\n      \u2502   \u2514\u2500\u2500 mydb/        # database name\n      \u2502       \u251c\u2500\u2500 schema/  # contains migration files\n      \u2502       \u2514\u2500\u2500 queries/ # contains query files\n'})}),(0,t.jsxs)(n.p,{children:["The presence of a ",(0,t.jsx)(n.code,{children:"schema"})," directory under your database name automatically declares the database in FTL."]})]}),(0,t.jsxs)(l.A,{value:"java",label:"Java",children:[(0,t.jsx)(n.p,{children:"For Java projects, SQL files must be located in:"}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'src/main/resources/\n  \u2514\u2500\u2500 db/\n      \u251c\u2500\u2500 mysql/           # must be exactly "mysql" or "postgres"\n      \u2502   \u2514\u2500\u2500 mydb/        # database name\n      \u2502       \u251c\u2500\u2500 schema/  # contains migration files\n      \u2502       \u2514\u2500\u2500 queries/ # contains query files\n'})}),(0,t.jsxs)(n.p,{children:["The presence of a ",(0,t.jsx)(n.code,{children:"schema"})," directory under your database name automatically declares the database in FTL."]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"schema-directory",children:"Schema Directory"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"schema"})," directory contains all your database migration ",(0,t.jsx)(n.code,{children:".sql"})," files. These files are used to create and modify your database schema."]}),"\n",(0,t.jsx)(n.h3,{id:"queries-directory",children:"Queries Directory"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"queries"})," directory contains ",(0,t.jsx)(n.code,{children:".sql"})," files with any SQL queries you would like generated as FTL verbs for use in your module. These queries must be annotated with ",(0,t.jsx)(n.a,{href:"https://docs.sqlc.dev/",children:"SQLC annotation syntax"}),". FTL will automatically lift these queries into the module schema and provide a type-safe client to execute each query."]}),"\n",(0,t.jsxs)(n.p,{children:["Find more information in the ",(0,t.jsx)(n.a,{href:"#using-generated-query-clients",children:"Using Generated Query Clients"})," section below."]}),"\n",(0,t.jsx)(n.h2,{id:"provisioning",children:"Provisioning"}),"\n",(0,t.jsxs)(n.p,{children:["FTL includes support for automatically provisioning databases. The actual backing implementation is\nextensible, and presently we include support for both local development provisioning using docker,\nand cloud formations based provisioning for AWS deployments. When using ",(0,t.jsx)(n.code,{children:"ftl dev"})," a docker container\nwill automatically be spun up for each datasource that has been defined, and FTL will automatically\nhandle configuration. The same applies when deploying to an AWS cluster with cloud formations\nprovisioning setup."]}),"\n",(0,t.jsx)(n.h2,{id:"migrations",children:"Migrations"}),"\n",(0,t.jsxs)(n.p,{children:["FTL includes support for automatically running migrations on databases. This is provided by ",(0,t.jsx)(n.a,{href:"https://github.com/amacneil/dbmate",children:"dbmate"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["To create additional migrations you can use the ",(0,t.jsx)(n.code,{children:"ftl postgres new migration"})," or ",(0,t.jsx)(n.code,{children:"ftl mysql new migration"})," command. The format of the command is ",(0,t.jsx)(n.code,{children:"ftl <engine> new migration <module>.<datasource> <migration-name>"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"The module name can be omitted if the current working directory only contains a single module."}),"\n",(0,t.jsxs)(n.p,{children:["E.g. to create a new migration called ",(0,t.jsx)(n.code,{children:"init"})," for the ",(0,t.jsx)(n.code,{children:"testdb"})," datasource in the ",(0,t.jsx)(n.code,{children:"mysql"})," module you would run ",(0,t.jsx)(n.code,{children:"ftl mysql new migration mysql.testdb init"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"When the modules are provisioned FTL will automatically run these migrations for you."}),"\n",(0,t.jsx)(n.h2,{id:"connecting-with-your-db",children:"Connecting with your DB"}),"\n",(0,t.jsx)(n.p,{children:"There are two supported ways to interact with your database in FTL: using the generated database handle to perform raw queries, or using generated query clients."}),"\n",(0,t.jsx)(n.h3,{id:"using-the-generated-database-handle",children:"Using the Generated Database Handle"}),"\n",(0,t.jsxs)(i.A,{groupId:"languages",children:[(0,t.jsxs)(l.A,{value:"go",label:"Go",default:!0,children:[(0,t.jsxs)(n.p,{children:["Once you've declared a database, FTL automatically generates a database handle that provides direct access to the underlying connection. You can use this to execute raw SQL queries (where ",(0,t.jsx)(n.code,{children:"MydbHandle"})," is the generated handle type for the ",(0,t.jsx)(n.code,{children:"mydb"})," datasource):"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'//ftl:verb export\nfunc Query(ctx context.Context, db MydbHandle) ([]string, error) {\n\trows, err := db.QueryContext(ctx, "SELECT data FROM requests")\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tdefer rows.Close()\n\tvar items []string\n\tfor rows.Next() {\n\t\tvar i string\n\t\tif err := rows.Scan(&i); err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t\titems = append(items, i)\n\t}\n\tif err := rows.Close(); err != nil {\n\t\treturn nil, err\n\t}\n\tif err := rows.Err(); err != nil {\n\t\treturn nil, err\n\t}\n\treturn items, nil\n}\n'})})]}),(0,t.jsx)(l.A,{value:"kotlin",label:"Kotlin",children:(0,t.jsx)(n.p,{children:"TBD"})}),(0,t.jsx)(l.A,{value:"java",label:"Java",children:(0,t.jsx)(n.p,{children:"TBD"})}),(0,t.jsxs)(l.A,{value:"schema",label:"Schema",children:[(0,t.jsxs)(n.p,{children:["In the FTL schema, the database handle is represented by the ",(0,t.jsx)(n.code,{children:"+database calls"})," annotation on verbs:"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-schema",children:"module example {\n  // Database declaration\n  database postgres mydb\n    +migration sha256:59b989063b6de57a1b6867e8ad7915109c9b8632616118c6ef23e4439cf17f8e\n  \n  // Verb that uses the database handle directly\n  export verb query(Unit) [String]\n    +database calls example.mydb\n}\n"})}),(0,t.jsx)(n.p,{children:"When you use a database handle in your code, you're directly accessing the underlying database connection. The FTL compiler automatically generates the appropriate handle type based on the database declaration."})]})]}),"\n",(0,t.jsx)(n.h3,{id:"using-generated-query-clients",children:"Using Generated Query Clients"}),"\n",(0,t.jsxs)(n.p,{children:["For better type safety and maintainability, FTL can automatically generate type-safe query clients from SQL files in your ",(0,t.jsx)(n.code,{children:"queries"})," directory. Your SQL files must be annotated with ",(0,t.jsx)(n.a,{href:"https://docs.sqlc.dev/",children:"SQLC annotation syntax"})," to specify the type of query and its parameters. For example:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- name: GetUser :one\nSELECT id, name, email\nFROM users\nWHERE id = $1;\n\n-- name: ListUsers :many\nSELECT id, name, email\nFROM users\nORDER BY name;\n\n-- name: CreateUser :exec\nINSERT INTO users (name, email)\nVALUES ($1, $2);\n"})}),"\n",(0,t.jsx)(n.p,{children:"These queries will be automatically converted into FTL verbs with corresponding generated clients that you can inject into your verbs just like any other verb client. For example:"}),"\n",(0,t.jsxs)(i.A,{groupId:"languages",children:[(0,t.jsx)(l.A,{value:"go",label:"Go",default:!0,children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'//ftl:verb export\nfunc GetEmail(ctx context.Context, id int, query GetUserClient) (string, error) {\n\tresult, err := query(ctx, id)\n\tif err != nil {\n\t\treturn "", err\n\t}\n\treturn result.Email, nil\n}\n'})})}),(0,t.jsx)(l.A,{value:"kotlin",label:"Kotlin",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-kotlin",children:"@Verb\nfun getEmail(id: Int, query: GetUserClient): String {\n    val result = query.getUser(id)\n    return result.email\n}\n"})})}),(0,t.jsx)(l.A,{value:"java",label:"Java",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"@Verb\npublic String getEmail(int id, GetUserClient query) {\n    UserResult result = query.getUser(id);\n    return result.getEmail();\n}\n"})})}),(0,t.jsxs)(l.A,{value:"schema",label:"Schema",children:[(0,t.jsxs)(n.p,{children:["In the FTL schema, the generated query clients are represented as verbs with the ",(0,t.jsx)(n.code,{children:"+database calls"})," and ",(0,t.jsx)(n.code,{children:"+sql query"})," annotations:"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-schema",children:'module example {\n  // Database declaration\n  database postgres testdb\n    +migration sha256:59b989063b6de57a1b6867e8ad7915109c9b8632616118c6ef23e4439cf17f8e\n  \n  // Data structures for query results and parameters\n  data UserResult {\n    id Int +sql column "users"."id"\n    name String +sql column "users"."name"\n    email String +sql column "users"."email"\n  }\n  \n  data CreateUserParams {\n    name String\n    email String\n  }\n  \n  // Query that returns a single row\n  verb getUser(Int) example.UserResult\n    +database calls example.testdb\n    +sql query one "SELECT id, name, email FROM users WHERE id = ?"\n  \n  // Query that returns multiple rows\n  verb listUsers(Unit) [example.UserResult]\n    +database calls example.testdb\n    +sql query many "SELECT id, name, email FROM users ORDER BY name"\n  \n  // Query that performs an action but doesn\'t return data\n  verb createUser(example.CreateUserParams) Unit\n    +database calls example.testdb\n    +sql query exec "INSERT INTO users (name, email) VALUES (?, ?)"\n  \n  // Custom verb that uses the generated query client\n  export verb getUserEmail(Int) String\n    +calls example.getUser\n}\n'})}),(0,t.jsx)(n.p,{children:"When you use a generated query client in your code, you're calling a verb that has been automatically generated from your SQL query. FTL handles the mapping between your SQL queries and the generated verbs."})]})]}),"\n",(0,t.jsx)(n.h2,{id:"transactions",children:"Transactions"}),"\n",(0,t.jsx)(n.p,{children:"FTL provides transaction support through verb annotations. When a verb is marked as transactional, FTL will automatically manage the transaction boundaries - beginning the transaction when the verb is called, committing if the verb completes successfully, and rolling back if any errors occur during execution."}),"\n",(0,t.jsxs)(i.A,{groupId:"languages",children:[(0,t.jsxs)(l.A,{value:"go",label:"Go",default:!0,children:[(0,t.jsxs)(n.p,{children:["To mark a verb as transactional, use the ",(0,t.jsx)(n.code,{children:"//ftl:transaction"})," comment directive:"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type CreateUserRequest struct {\n    Name  string\n    Email string\n}\n\n//ftl:transaction\nfunc CreateUser(ctx context.Context, req CreateUserRequest, db MydbHandle, createAddress CreateAddressClient) error {\n    // All database operations within this verb will be executed in a single transaction\n    result, err := db.Get(ctx).Exec("INSERT INTO users (name, email) VALUES ($1, $2)", req.Name, req.Email)\n    if err != nil {\n        return err // Transaction will be rolled back\n    }\n    \n    userId, err := result.LastInsertId()\n    if err != nil {\n        return err // Transaction will be rolled back\n    }\n    \n    // createAddress is a generated query client from a SQL file in queries/\n    err = createAddress(ctx, AddressRequest{UserId: userId})\n    if err != nil {\n        return err // Transaction will be rolled back\n    }\n    \n    return nil // Transaction will be committed\n}\n'})})]}),(0,t.jsxs)(l.A,{value:"kotlin",label:"Kotlin",children:[(0,t.jsxs)(n.p,{children:["To mark a verb as transactional, use the ",(0,t.jsx)(n.code,{children:"@Transactional"})," annotation:"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-kotlin",children:"data class CreateUserRequest(\n    val name: String,\n    val email: String\n)\n\n@Transactional\nfun createUser(\n    request: CreateUserRequest,\n    createAddress: CreateAddressClient // Generated query client\n): Unit {    \n    // createAddress is a generated query client from a SQL file in queries/\n    createAddress.createAddress(AddressRequest(userId = userId))\n    // Transaction commits if we reach here without errors\n    // Any errors will cause automatic rollback\n}\n"})})]}),(0,t.jsxs)(l.A,{value:"java",label:"Java",children:[(0,t.jsxs)(n.p,{children:["To mark a verb as transactional, use the ",(0,t.jsx)(n.code,{children:"@Transactional"})," annotation:"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"public class CreateUserRequest {\n    private String name;\n    private String email;\n}\n\npublic class UserService {\n    @Transactional\n    public void createUser(\n        CreateUserRequest request,\n        CreateAddressClient createAddress  // Generated query client\n    ) { \n        // createAddress is a generated query client from a SQL file in queries/\n        createAddress.createAddress(new AddressRequest(userId));\n        // Transaction commits if we reach here without errors\n        // Any errors will cause automatic rollback\n    }\n}\n"})})]}),(0,t.jsxs)(l.A,{value:"schema",label:"Schema",children:[(0,t.jsxs)(n.p,{children:["In the FTL schema, transaction verbs are represented with the ",(0,t.jsx)(n.code,{children:"+transaction"})," annotation:"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-schema",children:'module example {\n  // Database declaration\n  database postgres mydb\n    +migration sha256:59b989063b6de57a1b6867e8ad7915109c9b8632616118c6ef23e4439cf17f8e\n  \n  data CreateUserRequest {\n    name String\n    email String\n  }\n  \n  data AddressRequest {\n    userId Int +sql column "addresses"."id"\n    street String +sql column "addresses"."street"\n    city String +sql column "addresses"."city"\n  }\n  \n  // Generated query client from SQL file\n  verb createAddress(example.AddressRequest) Unit\n    +database calls example.mydb\n    +sql query exec "INSERT INTO addresses (user_id, street, city) VALUES (?, ?, ?)"\n  \n  // Transaction verb that uses both direct database access and a generated query client\n  verb createUser(example.CreateUserRequest) Unit\n    +transaction\n    +database calls example.mydb\n    +calls example.createAddress\n}\n'})})]})]}),"\n",(0,t.jsx)(n.h3,{id:"transaction-rules-and-limitations",children:"Transaction Rules and Limitations"}),"\n",(0,t.jsx)(n.p,{children:"When using transactions, FTL enforces the following restrictions:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Database Usage"}),": Transaction verbs must use at least one database resource (either through a database handle or SQL query clients). FTL infers which database to open the transaction against based on these usages."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Single Database"}),": FTL only supports transactions against a single database. Two-phase commits across multiple databases are not supported."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"No Nesting"}),": Transaction verbs cannot be nested. This means you cannot inject another transaction verb's client as a resource within a transaction verb."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Module Scope"}),": Transaction verbs can only call other verbs within the same module. Calls to external verbs from other modules are not allowed within a transaction."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Automatic Management"}),": Transaction boundaries are automatically managed by FTL:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"The transaction begins when the verb is called"}),"\n",(0,t.jsx)(n.li,{children:"The transaction commits if the verb completes successfully"}),"\n",(0,t.jsx)(n.li,{children:"The transaction rolls back if any errors occur during execution"}),"\n"]}),"\n"]}),"\n"]})]})}function m(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},9077:(e,n,a)=>{a.d(n,{A:()=>q});var r=a(8225),t=a(3372),s=a(9101),i=a(1654),l=a(8827),c=a(6550),o=a(4727),d=a(6716);function u(e){return r.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:n,children:a}=e;return(0,r.useMemo)((()=>{const e=n??function(e){return u(e).map((e=>{let{props:{value:n,label:a,attributes:r,default:t}}=e;return{value:n,label:a,attributes:r,default:t}}))}(a);return function(e){const n=(0,o.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,a])}function m(e){let{value:n,tabValues:a}=e;return a.some((e=>e.value===n))}function b(e){let{queryString:n=!1,groupId:a}=e;const t=(0,i.W6)(),s=function(e){let{queryString:n=!1,groupId:a}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!a)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return a??null}({queryString:n,groupId:a});return[(0,c.aZ)(s),(0,r.useCallback)((e=>{if(!s)return;const n=new URLSearchParams(t.location.search);n.set(s,e),t.replace({...t.location,search:n.toString()})}),[s,t])]}function p(e){const{defaultValue:n,queryString:a=!1,groupId:t}=e,s=h(e),[i,c]=(0,r.useState)((()=>function(e){let{defaultValue:n,tabValues:a}=e;if(0===a.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!m({value:n,tabValues:a}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${a.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const r=a.find((e=>e.default))??a[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:n,tabValues:s}))),[o,u]=b({queryString:a,groupId:t}),[p,g]=function(e){let{groupId:n}=e;const a=function(e){return e?`docusaurus.tab.${e}`:null}(n),[t,s]=(0,d.Dv)(a);return[t,(0,r.useCallback)((e=>{a&&s.set(e)}),[a,s])]}({groupId:t}),x=(()=>{const e=o??p;return m({value:e,tabValues:s})?e:null})();(0,l.A)((()=>{x&&c(x)}),[x]);return{selectedValue:i,selectValue:(0,r.useCallback)((e=>{if(!m({value:e,tabValues:s}))throw new Error(`Can't select invalid tab value=${e}`);c(e),u(e),g(e)}),[u,g,s]),tabValues:s}}var g=a(6425);const x={tabList:"tabList_m0Yb",tabItem:"tabItem_Mhwx"};var y=a(7557);function f(e){let{className:n,block:a,selectedValue:r,selectValue:i,tabValues:l}=e;const c=[],{blockElementScrollPositionUntilNextRender:o}=(0,s.a_)(),d=e=>{const n=e.currentTarget,a=c.indexOf(n),t=l[a].value;t!==r&&(o(n),i(t))},u=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const a=c.indexOf(e.currentTarget)+1;n=c[a]??c[0];break}case"ArrowLeft":{const a=c.indexOf(e.currentTarget)-1;n=c[a]??c[c.length-1];break}}n?.focus()};return(0,y.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,t.A)("tabs",{"tabs--block":a},n),children:l.map((e=>{let{value:n,label:a,attributes:s}=e;return(0,y.jsx)("li",{role:"tab",tabIndex:r===n?0:-1,"aria-selected":r===n,ref:e=>{c.push(e)},onKeyDown:u,onClick:d,...s,className:(0,t.A)("tabs__item",x.tabItem,s?.className,{"tabs__item--active":r===n}),children:a??n},n)}))})}function j(e){let{lazy:n,children:a,selectedValue:s}=e;const i=(Array.isArray(a)?a:[a]).filter(Boolean);if(n){const e=i.find((e=>e.props.value===s));return e?(0,r.cloneElement)(e,{className:(0,t.A)("margin-top--md",e.props.className)}):null}return(0,y.jsx)("div",{className:"margin-top--md",children:i.map(((e,n)=>(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==s})))})}function v(e){const n=p(e);return(0,y.jsxs)("div",{className:(0,t.A)("tabs-container",x.tabList),children:[(0,y.jsx)(f,{...n,...e}),(0,y.jsx)(j,{...n,...e})]})}function q(e){const n=(0,g.A)();return(0,y.jsx)(v,{...e,children:u(e.children)},String(n))}}}]);