syntax = "proto3";

package xyz.block.ftl.v1;

import "xyz/block/ftl/schema/v1/schema.proto";
import "xyz/block/ftl/v1/ftl.proto";

option go_package = "github.com/block/ftl/backend/protos/xyz/block/ftl/v1;ftlv1";
option java_multiple_files = true;

message GetSchemaRequest {}
message GetSchemaResponse {
  ftl.schema.v1.Schema schema = 1;
  repeated ftl.schema.v1.Changeset changesets = 2;
}

message PullSchemaRequest {}
message PullSchemaResponse {
  // ChangesetCreated is sent when a new changeset is created.
  message ChangesetCreated {
    ftl.schema.v1.Changeset changeset = 1;
  }

  // ChangesetFailed is sent when a changeset fails.
  message ChangesetFailed {
    string key = 1;
    string error = 2;
  }

  // ChangesetFailed is sent when a changeset becomes canonical.
  message ChangesetCommited {
    string key = 1;
  }

  // Deployment created is sent when a deployment is new to the listener but is not part of a changeset.
  message DeploymentCreated {
    // Will not be set for builtin modules.
    // optional string key = 1;
    // string module_name = 2;
    // If present, the deployment is not yet canonical as it is currently part of a changeset.
    // optional string changeset = 3;

    optional ftl.schema.v1.Module schema = 1;
  }

  message DeploymentUpdated {
    // Will not be set for builtin modules.
    // optional string key = 1;
    // string module_name = 2;
    // If present, the deployment is not yet canonical as it is currently part of a changeset.
    optional string changeset = 1;

    optional ftl.schema.v1.Module schema = 2;
  }

  message DeploymentRemoved {
    // Will not be set for builtin modules.
    optional string key = 1;
    string module_name = 2;

    // If this is true then the module was removed as well as the deployment.
    bool module_removed = 3;
  }

  oneof event {
    ChangesetCreated changeset_created = 4;
    ChangesetFailed changeset_failed = 5;
    ChangesetCommited changeset_commited = 6;
    DeploymentCreated deployment_created = 7;
    DeploymentUpdated deployment_updated = 8;
    DeploymentRemoved deployment_removed = 9;
  }

  // If true there are more schema changes immediately following this one as part of the initial batch.
  // If false this is the last schema change in the initial batch, but others may follow later.
  bool more = 31634;
}

message UpdateDeploymentRuntimeRequest {
  string deployment = 1;
  optional string changeset = 2;
  ftl.schema.v1.ModuleRuntimeEvent event = 3;
}

message UpdateDeploymentRuntimeResponse {}

message CreateChangesetRequest {
  repeated ftl.schema.v1.Module modules = 1;
}

message CreateChangesetResponse {
  // The changeset key of the newly created changeset.
  string changeset = 1;
}

message CommitChangesetRequest {
  // The changeset key to commit.
  string changeset = 1;
}

message CommitChangesetResponse {}

message FailChangesetRequest {
  // The changeset key to fail.
  string changeset = 1;
  string error = 2;
}

message FailChangesetResponse {}

service SchemaService {
  // Ping service for readiness.
  rpc Ping(PingRequest) returns (PingResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }

  // Get the full schema.
  rpc GetSchema(GetSchemaRequest) returns (GetSchemaResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }

  // Pull schema changes from the Controller.
  //
  // Note that if there are no deployments this will block indefinitely, making it unsuitable for
  // just retrieving the schema. Use GetSchema for that.
  rpc PullSchema(PullSchemaRequest) returns (stream PullSchemaResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }

  // UpdateModuleRuntime is used to update the runtime configuration of a module.
  rpc UpdateDeploymentRuntime(UpdateDeploymentRuntimeRequest) returns (UpdateDeploymentRuntimeResponse);

  // CreateChangeset creates a new changeset.
  rpc CreateChangeset(CreateChangesetRequest) returns (CreateChangesetResponse);

  // CommitChangeset makes all deployments for the changeset part of the canonical schema.
  rpc CommitChangeset(CommitChangesetRequest) returns (CommitChangesetResponse);

  // FailChangeset fails an active changeset.
  rpc FailChangeset(FailChangesetRequest) returns (FailChangesetResponse);
}
